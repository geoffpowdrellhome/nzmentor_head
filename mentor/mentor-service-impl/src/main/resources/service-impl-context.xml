<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:cxf="http://cxf.apache.org/core"
       xmlns:jaxws="http://cxf.apache.org/jaxws"
       xmlns:http-conf="http://cxf.apache.org/transports/http/configuration"
       xmlns:sec="http://cxf.apache.org/configuration/security"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx" xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/context
		http://www.springframework.org/schema/context/spring-context-3.0.xsd
		http://cxf.apache.org/core
		http://cxf.apache.org/schemas/core.xsd
		http://www.springframework.org/schema/tx
		http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
		http://cxf.apache.org/jaxws
		http://cxf.apache.org/schemas/jaxws.xsd
		http://cxf.apache.org/configuration/security
		http://cxf.apache.org/schemas/configuration/security.xsd
		http://cxf.apache.org/transports/http/configuration
		http://cxf.apache.org/schemas/configuration/http-conf.xsd
      http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">

    <!-- Load spring config from DAO layer -->
    <import resource="classpath:datasource-context.xml"/>

    <!-- scan for components from faregate package -->
    <context:component-scan base-package="net.flitech.faregate.air"/>
    <context:component-scan base-package="net.flitech.faregate.factory"/>
    <context:component-scan base-package="net.flitech.faregate.service"/>
    <context:component-scan base-package="net.flitech.faregate.config.impl"/>
    <context:component-scan base-package="net.flitech.integration.jaxb" />
    <context:component-scan base-package="net.flitech.faregate.test.base" />
    <context:component-scan base-package="com.nz.travel.mentor.util" />

    <tx:annotation-driven/>


    <!-- =================================================================== -->
    <!-- CXF WEB SERVICE STUFF -->
    <!-- =================================================================== -->

    <!-- Load CXF modules from cxf.jar -->
    <import resource="classpath:META-INF/cxf/cxf.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-extension-soap.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-servlet.xml"/>

    <!-- Enable message logging using the CXF logging feature -->
    <cxf:bus>
        <cxf:features>
            <cxf:logging/>
        </cxf:features>
    </cxf:bus>

    <bean id="outPasswordInterceptor" class="org.apache.cxf.ws.security.wss4j.WSS4JOutInterceptor">
        <constructor-arg>
            <map>
                <entry key="action" value="UsernameToken"/>
                <entry key="passwordType" value="PasswordText"/>
                <entry key="signaturePropFile" value="..."/>
                <entry key="user" value="anything"/>
                <entry key="passwordCallbackRef">
                    <ref bean="passwordCallback"/>
                </entry>
            </map>
        </constructor-arg>
    </bean>

    <bean class="com.tzavellas.circuitbreaker.spring.SpringXmlConfigurationSupport"/>

    <!-- TODO when bug 8547 circuit breaker performance issue is fixed, set maxFailures back to 3 -->
    <!-- @see http://bugzilla.au.flitech.net/show_bug.cgi?id=8547 -->
    <bean id="defaultSearchBreaker" class="com.tzavellas.circuitbreaker.spring.CircuitBreaker" abstract="true">
        <property name="maxFailures" value="60"/>
        <!--               Number of failures before tripping -->
        <property name="currentFailuresDuration" value="30s"/>
        <!--  How long before failures expire -->
        <property name="timeout" value="60s"/>
        <!--                 How long before the breaker resets  -->
        <property name="ignoredExceptions" ref="ignoredExceptionsForSearch"/>
    </bean>

    <util:set id="ignoredExceptionsForSearch">
        <value>net.flitech.faregate.ValidationException</value>
    </util:set>

    <bean id="appPropertyFileUrl" class="java.lang.String">
        <constructor-arg value="${user.home}/fgconfiguration/app.properties"/>
    </bean>

    <!--<bean id="defaultFaregateAppConfig" class="net.flitech.faregate.config.impl.DefaultFaregateAppConfig"/>-->

    <util:set id="invalidFareTypes">
        <value>UNKNOWN</value>
        <value>INVALID</value>
    </util:set>
    <util:map id="airlineGstCodes">
        <entry key="QF" value="YR"/>
        <entry key="AF" value="YR"/>
        <entry key="SQ" value="YR"/>
        <entry key="XR" value="YR"/>
        <entry key="NZ" value="YR"/>
        <entry key="VA" value="YR"/>
        <entry key="KL" value="YQ"/>
    </util:map>
    <util:map id="connectingAirlines">
        <entry key="QF" value="1-399"/>
    </util:map>
    <util:set id="nzPseudos">
        <value>7EN8</value>
    </util:set>


    <!-- used by ThreadedFareGateServiceInterrogator to thread its Availability calls -->
	<bean id="getAvailabilityExecutor" class="java.util.concurrent.Executors"
		factory-method="newCachedThreadPool" />
	<!-- used by ThreadedFareGateServiceInterrogator to thread its Quote calls -->
	<bean id="quoteFlightExecutor" class="java.util.concurrent.Executors"
		factory-method="newCachedThreadPool" />
	<!-- used by ThreadedFareGateServiceInterrogator to thread its Book calls -->
	<bean id="bookFlightExecutor" class="java.util.concurrent.Executors"
		factory-method="newCachedThreadPool" />
	<!-- used by ThreadedFareGateServiceInterrogator to thread its Cancel Booking calls -->
	<bean id="cancelBookingExecutor" class="java.util.concurrent.Executors"
		factory-method="newCachedThreadPool" />
	<!-- used by ThreadedFareGateServiceInterrogator to thread its Retrieve Bookings calls -->
	<bean id="retrieveBookingsExecutor" class="java.util.concurrent.Executors"
		factory-method="newCachedThreadPool" />



</beans>